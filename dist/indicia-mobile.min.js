(function(){"use strict";function a(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function b(a){var b=a.split(/\r\n|\r|\n/g);return{usersecret:b[0],firstname:b[1],lastname:b[2]}}var c=function(a){this.base_url=a.base_url,this.appname=a.appname,this.appsecret=a.appsecret,this.website_id=a.website_id,this.survey_id=a.survey_id,this.credentials={usersecret:a.usersecret||null,email:a.email||null}};c.prototype._request=function(a,b,c){var d=a.indexOf("//")>=0?a:this.base_url+a;d=d+(/\?/.test(d)?"&":"?")+(new Date).getTime();var e=new FormData;for(var f in b)b.hasOwnProperty(f)&&e.append(f,b[f]);if(e.append("appname",this.appname),e.append("appsecret",this.appsecret),c)for(var g=0;g<c.length;g++){var h=c[g];e.append(h.name,h.data,h.filename)}return new Promise(function(a,b){var c=new XMLHttpRequest;c.open("POST",d),c.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300?a({body:this.responseText,response:this}):b(this.status))},c.send(e)})},c.prototype.login=function(a,c){var d=this;return this._request("/user/mobile/register",{email:a,password:c}).then(function(c){return c=b(c.body),d.credentials={email:a,usersecret:c.usersecret},d.credentials})},c.prototype.logout=function(){this.credentials={usersecret:null,email:null}},c.prototype.isLoggedIn=function(){return!!this.credentials.usersecret},c.prototype.register=function(a){var c=this;this._request("/user/mobile/register",a).then(function(d){return d=b(d.body),c.credentials={email:a.email,usersecret:d.usersecret},c.credentials})},c.prototype.report=function(a){return a=a||{},this.isLoggedIn()?this._request("/mobile/report",{email:this.credentials.email,usersecret:this.credentials.usersecret,report:a.report||"library/totals/user_survey_contribution_summary.xml",survey_id:a.survey_id||this.survey_id}).then(function(a){return JSON.parse(a.body)}):Promise.reject(Error("Must be logged in"))},c.prototype.submit=function(b,c){c=a({authenticated:!0},c||{});var d={appname:this.appname,appsecret:this.appsecret,website_id:this.website_id,survey_id:this.survey_id};return this.isLoggedIn()?(c.authenticated&&(d.email=this.credentials.email,d.usersecret=this.credentials.usersecret),a(d,b.encode()),this._request("/mobile/submit",d,b.uploads).then(function(a){return a.body})["catch"](function(a){switch(a){case 400:a="An Unexpected Error Occured"}throw Error(a)})):Promise.reject(Error("Must be logged in"))},c.Sample=function(b){this.fields=a({entered_sref:null,entered_sref_system:null,date:null,comment:null},b||{}),this.occurrences=[],this.uploads=[]},c.Sample.prototype.set=function(a,b){return this.fields[a]=b,this},c.Sample.prototype.encode=function(){var b={};for(var c in this.fields)this.fields.hasOwnProperty(c)&&(b["sample:"+c]=this.fields[c]);for(var d=0;d<this.occurrences.length;d++)a(b,this.occurrences[d].encode(d+1));return b},c.Sample.prototype.addOccurrence=function(a){var b=new c.Occurrence(a);return this.occurrences.push(b),b},c.Occurrence=function(b){this.fields=a({taxa_taxon_list_id:null},b||{})},c.Occurrence.prototype.set=function(a,b){return this.fields[a]=b,this},c.Occurrence.prototype.encode=function(a){var b={};for(var c in this.fields)this.fields.hasOwnProperty(c)&&(b["sc:"+a+"::"+c]=this.fields[c]);return b},window.IndiciaMobile=c}).call(this);