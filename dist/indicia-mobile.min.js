(function(){"use strict";function a(a){return"function"==typeof a||"object"==typeof a&&null!==a}function b(a){return"function"==typeof a}function c(a){return"object"==typeof a&&null!==a}function d(a){P=a}function e(a){T=a}function f(){var a=process.nextTick,b=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(b)&&"0"===b[1]&&"10"===b[2]&&(a=setImmediate),function(){a(k)}}function g(){return function(){O(k)}}function h(){var a=0,b=new W(k),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function i(){var a=new MessageChannel;return a.port1.onmessage=k,function(){a.port2.postMessage(0)}}function j(){return function(){setTimeout(k,1)}}function k(){for(var a=0;S>a;a+=2){var b=Z[a],c=Z[a+1];b(c),Z[a]=void 0,Z[a+1]=void 0}S=0}function l(){try{var a=require,b=a("vertx");return O=b.runOnLoop||b.runOnContext,g()}catch(c){return j()}}function m(){}function n(){return new TypeError("You cannot resolve a promise with itself")}function o(){return new TypeError("A promises callback cannot return that same promise.")}function p(a){try{return a.then}catch(b){return ba.error=b,ba}}function q(a,b,c,d){try{a.call(b,c,d)}catch(e){return e}}function r(a,b,c){T(function(a){var d=!1,e=q(c,b,function(c){d||(d=!0,b!==c?u(a,c):w(a,c))},function(b){d||(d=!0,x(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,x(a,e))},a)}function s(a,b){b._state===_?w(a,b._result):b._state===aa?x(a,b._result):y(b,void 0,function(b){u(a,b)},function(b){x(a,b)})}function t(a,c){if(c.constructor===a.constructor)s(a,c);else{var d=p(c);d===ba?x(a,ba.error):void 0===d?w(a,c):b(d)?r(a,c,d):w(a,c)}}function u(b,c){b===c?x(b,n()):a(c)?t(b,c):w(b,c)}function v(a){a._onerror&&a._onerror(a._result),z(a)}function w(a,b){a._state===$&&(a._result=b,a._state=_,0!==a._subscribers.length&&T(z,a))}function x(a,b){a._state===$&&(a._state=aa,a._result=b,T(v,a))}function y(a,b,c,d){var e=a._subscribers,f=e.length;a._onerror=null,e[f]=b,e[f+_]=c,e[f+aa]=d,0===f&&a._state&&T(z,a)}function z(a){var b=a._subscribers,c=a._state;if(0!==b.length){for(var d,e,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?C(c,d,e,f):e(f);a._subscribers.length=0}}function A(){this.error=null}function B(a,b){try{return a(b)}catch(c){return ca.error=c,ca}}function C(a,c,d,e){var f,g,h,i,j=b(d);if(j){if(f=B(d,e),f===ca?(i=!0,g=f.error,f=null):h=!0,c===f)return void x(c,o())}else f=e,h=!0;c._state!==$||(j&&h?u(c,f):i?x(c,g):a===_?w(c,f):a===aa&&x(c,f))}function D(a,b){try{b(function(b){u(a,b)},function(b){x(a,b)})}catch(c){x(a,c)}}function E(a,b){var c=this;c._instanceConstructor=a,c.promise=new a(m),c._validateInput(b)?(c._input=b,c.length=b.length,c._remaining=b.length,c._init(),0===c.length?w(c.promise,c._result):(c.length=c.length||0,c._enumerate(),0===c._remaining&&w(c.promise,c._result))):x(c.promise,c._validationError())}function F(a){return new da(this,a).promise}function G(a){function b(a){u(e,a)}function c(a){x(e,a)}var d=this,e=new d(m);if(!R(a))return x(e,new TypeError("You must pass an array to race.")),e;for(var f=a.length,g=0;e._state===$&&f>g;g++)y(d.resolve(a[g]),void 0,b,c);return e}function H(a){var b=this;if(a&&"object"==typeof a&&a.constructor===b)return a;var c=new b(m);return u(c,a),c}function I(a){var b=this,c=new b(m);return x(c,a),c}function J(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function K(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function L(a){this._id=ia++,this._state=void 0,this._result=void 0,this._subscribers=[],m!==a&&(b(a)||J(),this instanceof L||K(),D(this,a))}function M(){var a;if("undefined"!=typeof global)a=global;else if("undefined"!=typeof self)a=self;else try{a=Function("return this")()}catch(b){throw new Error("polyfill failed because global object is unavailable in this environment")}var c=a.Promise;(!c||"[object Promise]"!==Object.prototype.toString.call(c.resolve())||c.cast)&&(a.Promise=ja)}var N;N=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};var O,P,Q,R=N,S=0,T=({}.toString,function(a,b){Z[S]=a,Z[S+1]=b,S+=2,2===S&&(P?P(k):Q())}),U="undefined"!=typeof window?window:void 0,V=U||{},W=V.MutationObserver||V.WebKitMutationObserver,X="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Y="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Z=new Array(1e3);Q=X?f():W?h():Y?i():void 0===U&&"function"==typeof require?l():j();var $=void 0,_=1,aa=2,ba=new A,ca=new A;E.prototype._validateInput=function(a){return R(a)},E.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},E.prototype._init=function(){this._result=new Array(this.length)};var da=E;E.prototype._enumerate=function(){for(var a=this,b=a.length,c=a.promise,d=a._input,e=0;c._state===$&&b>e;e++)a._eachEntry(d[e],e)},E.prototype._eachEntry=function(a,b){var d=this,e=d._instanceConstructor;c(a)?a.constructor===e&&a._state!==$?(a._onerror=null,d._settledAt(a._state,b,a._result)):d._willSettleAt(e.resolve(a),b):(d._remaining--,d._result[b]=a)},E.prototype._settledAt=function(a,b,c){var d=this,e=d.promise;e._state===$&&(d._remaining--,a===aa?x(e,c):d._result[b]=c),0===d._remaining&&w(e,d._result)},E.prototype._willSettleAt=function(a,b){var c=this;y(a,void 0,function(a){c._settledAt(_,b,a)},function(a){c._settledAt(aa,b,a)})};var ea=F,fa=G,ga=H,ha=I,ia=0,ja=L;L.all=ea,L.race=fa,L.resolve=ga,L.reject=ha,L._setScheduler=d,L._setAsap=e,L._asap=T,L.prototype={constructor:L,then:function(a,b){var c=this,d=c._state;if(d===_&&!a||d===aa&&!b)return this;var e=new this.constructor(m),f=c._result;if(d){var g=arguments[d-1];T(function(){C(d,e,g,f)})}else y(c,e,a,b);return e},"catch":function(a){return this.then(null,a)}};var ka=M,la={Promise:ja,polyfill:ka};"function"==typeof define&&define.amd?define(function(){return la}):"undefined"!=typeof module&&module.exports?module.exports=la:"undefined"!=typeof this&&(this.ES6Promise=la),ka()}).call(this),function(){"use strict";function a(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function b(a){var b=a.split(/\r\n|\r|\n/g);return{usersecret:b[0],firstname:b[1],lastname:b[2]}}var c=function(a){this.base_url=a.base_url,this.appname=a.appname,this.appsecret=a.appsecret,this.website_id=a.website_id,this.survey_id=a.survey_id,this.useRegistrationEndpoint=!1,a.hasOwnProperty("useRegistrationEndpoint")&&(this.useRegistrationEndpoint=a.useRegistrationEndpoint),this.credentials={usersecret:a.usersecret||null,email:a.email||null}};c.prototype.on=c.prototype.addEventListener=function(a,b){return this._callbacks=this._callbacks||{},(this._callbacks["$"+a]=this._callbacks["$"+a]||[]).push(b),this},c.prototype.off=c.prototype.removeListener=c.prototype.removeAllListeners=c.prototype.removeEventListener=function(a,b){if(this._callbacks=this._callbacks||{},0===arguments.length)return this._callbacks={},this;var c=this._callbacks["$"+a];if(!c)return this;if(1===arguments.length)return delete this._callbacks["$"+a],this;for(var d,e=0;e<c.length;e++)if(d=c[e],d===b||d.fn===b){c.splice(e,1);break}return this},c.prototype.emit=function(a){this._callbacks=this._callbacks||{};var b=[].slice.call(arguments,1),c=this._callbacks["$"+a];if(c){c=c.slice(0);for(var d=0,e=c.length;e>d;++d)c[d].apply(this,b)}return this},c.prototype._request=function(a,b){var c=a.indexOf("//")>=0?a:this.base_url+a;c=c+(/\?/.test(c)?"&":"?")+(new Date).getTime();var d=new FormData;for(var e in b)b.hasOwnProperty(e)&&("object"==typeof b[e]&&null!==b[e]?d.append(e,b[e].data,b[e].filename):d.append(e,b[e]));return d.append("appname",this.appname),d.append("appsecret",this.appsecret),new Promise(function(a,b){var e=new XMLHttpRequest;e.open("POST",c),e.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300?a({body:this.responseText,response:this}):b(this.status))},e.send(d)})},c.prototype.login=function(a,c){var d=this,e=this.useRegistrationEndpoint?"/user/mobile/register":"/user/mobile/login";return this._request(e,{email:a,password:c}).then(function(c){return c=b(c.body),d.credentials={email:a,usersecret:c.usersecret},d.emit("login",d.credentials),d.credentials})},c.prototype.logout=function(){this.credentials={usersecret:null,email:null},this.emit("logout")},c.prototype.isLoggedIn=function(){return!!this.credentials.usersecret},c.prototype.register=function(a){var c=this,d=this.useRegistrationEndpoint?"/user/mobile/register":"/user/mobile/signup";return this._request(d,a).then(function(d){return d=b(d.body),c.credentials={email:a.email,usersecret:d.usersecret},c.credentials})},c.prototype.report=function(a){return a=a||{},this.isLoggedIn()?this._request("/mobile/report",{email:this.credentials.email,usersecret:this.credentials.usersecret,report:a.report||"library/totals/user_survey_contribution_summary.xml",survey_id:a.survey_id||this.survey_id}).then(function(a){return JSON.parse(a.body)}):Promise.reject(Error("Must be logged in"))},c.prototype.submit=function(b,c){c=a({authenticated:!0},c||{});var d={appname:this.appname,appsecret:this.appsecret,website_id:this.website_id,survey_id:this.survey_id};return this.isLoggedIn()?(c.authenticated&&(d.email=this.credentials.email,d.usersecret=this.credentials.usersecret),a(d,b.encode()),this._request("/mobile/submit",d,b.uploads).then(function(a){return a.body})["catch"](function(a){switch(a){case 400:a="An Unexpected Error Occured"}throw Error(a)})):Promise.reject(Error("Must be logged in"))},c.Sample=function(b){this.fields=a({entered_sref:null,entered_sref_system:null,date:null,comment:null},b||{}),this.occurrences=[]},c.Sample.prototype.set=function(a,b){return this.fields[a]=b,this},c.Sample.prototype.encode=function(){var b={};for(var c in this.fields)this.fields.hasOwnProperty(c)&&(b["sample:"+c]=this.fields[c]);for(var d=0;d<this.occurrences.length;d++)a(b,this.occurrences[d].encode(d+1));return b},c.Sample.prototype.addOccurrence=function(a){var b=new c.Occurrence(a);return this.occurrences.push(b),b},c.Occurrence=function(b){this.fields=a({},b||{})},c.Occurrence.prototype.set=function(a,b){return this.fields[a]=b,this},c.Occurrence.prototype.encode=function(a){var b={};for(var c in this.fields)this.fields.hasOwnProperty(c)&&(b["sc:"+a+"::"+c]=this.fields[c]);return b},window.IndiciaMobile=c}.call(this);